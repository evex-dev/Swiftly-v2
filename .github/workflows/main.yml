name: Update and Restart Service

on:
  push:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  update-and-restart:
    runs-on: self-hosted

    steps:
      - name: Show environment information
        run: |
          echo "ğŸ” å®Ÿè¡Œç’°å¢ƒã®æƒ…å ±:"
          echo "Python version: $(python3 --version)"
          echo "Working directory: $(pwd)"
          echo "User: $(whoami)"
          echo "System info: $(uname -a)"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™..."
          cd /home/adminpi/Swiftly-v2
          source venv/bin/activate
          echo "Python virtual environment activated"
          curl -s https://raw.githubusercontent.com/evex-dev/Swiftly-v2/refs/heads/main/requirements.txt -o requirements.txt
          echo "Requirements.txt downloaded"
          pip install -r requirements.txt
          echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
          pip list
          echo "-------------------"

      - name: Pull latest changes
        run: |
          echo "ğŸ”„ æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã„ã¾ã™..."
          cd /home/adminpi/Swiftly-v2
          if [ -d ".git" ]; then
            echo "æ—¢å­˜ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
            git reset --hard
            git pull origin main
            echo "Current commit: $(git rev-parse HEAD)"
            echo "Current branch: $(git branch --show-current)"
          else
            echo "æ–°è¦ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™"
            git clone https://github.com/evex-dev/Swiftly-v2.git /home/adminpi/Swiftly-v2
          fi
          echo "âœ… å¤‰æ›´ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Check changed files
        id: changed-files
        run: |
          echo "ğŸ” å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
          cd /home/adminpi/Swiftly-v2

          # å‰å›ã®ã‚³ãƒŸãƒƒãƒˆã¨ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆã®é–“ã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD || git diff --name-only $(git hash-object -t tree /dev/null) HEAD)

          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          echo "$CHANGED_FILES"
          echo "-------------------"

          # cogsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          NON_COGS_CHANGES=$(echo "$CHANGED_FILES" | grep -v "^cogs/" || true)

          # bot.pyã¾ãŸã¯webapi.pyãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          CORE_FILES_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^(bot\.py)$" || true)

          if [ ! -z "$CORE_FILES_CHANGED" ]; then
            echo "âš ï¸ ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«(bot.py)ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "$CORE_FILES_CHANGED"
            echo "only_cogs_changed=false" >> $GITHUB_OUTPUT

          elif [ -z "$NON_COGS_CHANGES" ]; then
            echo "âœ… cogsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ã®å¤‰æ›´ã§ã™"
            echo "only_cogs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… cogsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥å¤–ã®å¤‰æ›´ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™"
            echo "å¤‰æ›´ã•ã‚ŒãŸcogsä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«:"
            echo "$NON_COGS_CHANGES"
            echo "only_cogs_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Reload cogs only
        if: steps.changed-files.outputs.only_cogs_changed == 'true'
        run: |
          echo "âœ… cogsã®ãƒªãƒ­ãƒ¼ãƒ‰ãŒå¤šåˆ†å®Œäº†ã—ã¾ã—ãŸ"

      - name: Restart systemd service
        if: steps.changed-files.outputs.only_cogs_changed == 'false'
        run: |
          echo "ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™..."
          sudo systemctl restart swiftly-bot.service